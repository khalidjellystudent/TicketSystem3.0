@model IEnumerable<TicketSystem.Models.Feedback>
@{
    ViewData["Title"] = "قائمة الرسائل";
    Layout = "_AdminLayout";
}

<section class="p-6">
    <h2 class="text-2xl font-bold mb-4">📩 قائمة الرسائل</h2>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg mb-4">
            @TempData["SuccessMessage"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4">
            @TempData["ErrorMessage"]
        </div>
    }

    @if (!Model.Any())
    {
        <div class="bg-yellow-50 border border-yellow-200 text-yellow-700 px-4 py-3 rounded-lg">
            لا توجد رسائل حتى الآن.
        </div>
    }
    else
    {
        <div class="bg-white shadow rounded-lg border border-gray-200 divide-y divide-gray-200">
            @foreach (var feedback in Model)
            {
                <div class="feedback-row @(feedback.IsRead ? "bg-white" : "bg-gray-200 font-bold")" 
                     data-id="@feedback.Id" style="cursor:pointer;">
                    <div class="flex justify-between p-4">
                        <div>
                            <span class="text-gray-900">@feedback.Name</span> - 
                            <span class="text-gray-600">
                                @(feedback.Message.Length > 50 ? feedback.Message.Substring(0, 50) + "..." : feedback.Message)
                            </span>
                        </div>
                        <div class="text-sm text-gray-500">
                            @feedback.CreatedAt.ToLocalTime().ToString("yyyy/MM/dd HH:mm")
                        </div>
                    </div>

                    <!-- Full message + delete button -->
                    <div class="feedback-full hidden border-t border-gray-200 p-4 text-gray-800">
                        <p class="mb-4">@feedback.Message</p>
                        <form asp-action="DeleteFeedback" asp-controller="Admin" method="post" 
                              onsubmit="return confirm('هل أنت متأكد أنك تريد حذف هذه الرسالة؟');">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@feedback.Id" />
                            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">
                                🗑 حذف الرسالة
                            </button>
                        </form>
                    </div>
                </div>
            }
        </div>
    }
</section>

@section Scripts {
<script>
document.querySelectorAll('.feedback-row').forEach(row => {
    row.addEventListener('click', function (e) {
        // Prevent click on delete button from toggling
        if (e.target.closest('form')) return;

        const fullMsg = this.querySelector('.feedback-full');
        fullMsg.classList.toggle('hidden');

        // If not read, mark as read in DB
        if (this.classList.contains('bg-gray-200')) {
            fetch('@Url.Action("MarkAsRead", "Admin")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                },
                body: `id=${this.dataset.id}`
            }).then(() => {
                this.classList.remove('bg-gray-200', 'font-bold');
                this.classList.add('bg-white');
            });
        }
    });
});
</script>
@Html.AntiForgeryToken()
}